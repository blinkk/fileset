<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>@blinkk/fileset</title>
	<meta name="description" content="Documentation for @blinkk/fileset">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.json" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">@blinkk/fileset</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1>@blinkk/fileset</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#fileset" id="fileset" style="color: inherit; text-decoration: none;">
					<h1>Fileset</h1>
				</a>
				<p><img src="https://github.com/blinkkcode/fileset/workflows/Run%20tests/badge.svg" alt="Master"></p>
				<p>Fileset is a light, high-performance TypeScript static web server intended for
					high-traffic sites. Features include preview branches backed by Google Account
					authentication, redirects, localization-aware serving, atomic deployments, and
				timed deployments.</p>
				<p>Instructions for deployment onto Google App Engine (backed by Cloud Datastore
				and Cloud Storage) are provided.</p>
				<a href="#concept" id="concept" style="color: inherit; text-decoration: none;">
					<h2>Concept</h2>
				</a>
				<p>Many websites can be built and deployed as fully static packages (i.e. just
					HTML, CSS, and JavaScript – with no dynamic backend). In these instances,
					websites may still have other requirements such as localization, redirects, or
					atomic deployments that end up adding slight dynamic functionality to an
				otherwise fully static project.</p>
				<p>Fileset aims to bridge the gap by offering a thin middle layer on top of Google
					Cloud Storage: static files are uploaded to Google Cloud Storage via the CLI,
					with the Fileset server handling request traffic. The server determines whether
					to issue a response sprinkled with one of the above dynamic features, and
					otherwise proxies traffic directly to Google Cloud Storage – leveraging Google&#39;s
				global network for performance.</p>
				<a href="#usage" id="usage" style="color: inherit; text-decoration: none;">
					<h2>Usage</h2>
				</a>
				<p>There are two main tasks required in order to use Fileset. First, you&#39;ll need to
					deploy the application server and configure the Identity-Aware Proxy. This only
					needs to be done once, when the project is originally set up. Secondly, you&#39;ll
					need to upload files to be served. Files must be uploaded each time you want to
				serve new files to users, or update redirects, etc.</p>
				<a href="#server-setup" id="server-setup" style="color: inherit; text-decoration: none;">
					<h3>Server setup</h3>
				</a>
				<p>NOTE: Fileset uses the default App Engine Google Cloud Storage bucket
				(<code>gs://appid.appspot.com</code>) to upload files.</p>
				<ol>
					<li><p>Within your project, create a directory to house the server files, e.g.
							<code>./backend/server</code>. Avoid mixing the server configuration with any tools to
							build your website. The <code>package.json</code>, etc. should be kept separate in order
						to keep the deployment slim.</p>
					</li>
					<li><p>Create a <code>package.json</code> like the below. App Engine will use <code>npm start</code> to
						run the server.</p>
					</li>
				</ol>
				<pre><code class="language-json">{
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    <span class="hljs-attr">&quot;start&quot;</span>: <span class="hljs-string">&quot;fileset serve&quot;</span>
  },
  <span class="hljs-attr">&quot;dependencies&quot;</span>: {
    <span class="hljs-attr">&quot;@blinkk/fileset&quot;</span>: <span class="hljs-string">&quot;^0.1.0&quot;</span>
  }
}</code></pre>
				<ol start="3">
					<li>Create an <code>app.yaml</code> for Google App Engine deployment.</li>
				</ol>
				<pre><code class="language-yaml"><span class="hljs-attr">service:</span> <span class="hljs-string">fileset</span>
<span class="hljs-attr">runtime:</span> <span class="hljs-string">nodejs10</span>
<span class="hljs-attr">env_variables:</span>
  <span class="hljs-attr">FILESET_SITE:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">FILESET_LIVE_DOMAIN:</span> <span class="hljs-string">example.com</span>
  <span class="hljs-attr">FILESET_STAGING_DOMAIN:</span> <span class="hljs-string">&#x27;{ref}.staging.example.com&#x27;</span></code></pre>
				<ol start="4">
					<li>Create a <code>Makefile</code> to help run setup commands.</li>
				</ol>
				<pre><code class="language-make">project := &lt;AppId&gt;  <span class="hljs-comment"># Replace with your App ID.</span>

<span class="hljs-section">setup:</span>
    gcloud app create --project=<span class="hljs-variable">$(project)</span>
    gcloud services enable datastore.googleapis.com --project=<span class="hljs-variable">$(project)</span>

<span class="hljs-section">deploy:</span>
    gcloud app deploy --project=<span class="hljs-variable">$(project)</span> app.yaml</code></pre>
				<ol start="5">
					<li>Deploy the app.</li>
				</ol>
				<pre><code class="language-bash">make setup
make deploy</code></pre>
				<a href="#deployment-setup" id="deployment-setup" style="color: inherit; text-decoration: none;">
					<h3>Deployment setup</h3>
				</a>
				<p>NOTE: Before you can deploy, you&#39;ll need to authenticate. Refer to the
					<a href="#uploader-authentication">authentication documentation</a> if you have not used
				Google Cloud Platform services before and need information on authentication.</p>
				<ol>
					<li>Create a <code>fileset.yaml</code> configuration file.</li>
				</ol>
				<pre><code class="language-yaml"><span class="hljs-comment"># Your Google Cloud project&#x27;s ID (required).</span>
<span class="hljs-attr">google_cloud_project:</span> <span class="hljs-string">&lt;AppId&gt;</span>

<span class="hljs-comment"># Your site ID (optional). If blank, `default` will be used.</span>
<span class="hljs-attr">site:</span> <span class="hljs-string">&lt;SiteId&gt;</span>

<span class="hljs-comment"># Specify a launch schedule. The schedule maps timestamps to branches or commit</span>
<span class="hljs-comment"># shas. If blank, `main` is used for the default deployment.</span>
<span class="hljs-attr">schedule:</span>
  <span class="hljs-attr">default:</span> <span class="hljs-string">main</span>

<span class="hljs-attr">redirects:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-string">/foo</span>
  <span class="hljs-attr">to:</span> <span class="hljs-string">/bar</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-string">/intl/:locale/</span>
  <span class="hljs-attr">to:</span> <span class="hljs-string">/$locale/</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-string">/intl/:locale/*wildcard</span>
  <span class="hljs-attr">to:</span> <span class="hljs-string">/$locale/$wildcard</span></code></pre>
				<ol start="2">
					<li>Generate your files.</li>
				</ol>
				<p>Use a static site generator or just manually create a directory containing files
					to upload. In the below example, the files in the directory <code>build</code> are
				uploaded.</p>
				<ol start="4">
					<li>Upload your files.</li>
				</ol>
				<pre><code class="language-bash">fileset upload ./build</code></pre>
				<p>NOTE: The uploader will look for <code>fileset.yaml</code> within the <code>./build</code> directory
					first. If it&#39;s not found, it will look up in the parent folder for a
					<code>fileset.yaml</code> file. If the config file doesn&#39;t exist in the <code>./build</code> or parent
				folder, the uploader will abort.</p>
				<ol start="5">
					<li>That&#39;s it! Files have been uploaded to Google Cloud Storage and the uploaded
					directory is now being served by the application server.</li>
				</ol>
				<p>TODO: Document Identity-Aware Proxy setup and CLI authentication.</p>
				<a href="#uploader-authentication" id="uploader-authentication" style="color: inherit; text-decoration: none;">
					<h2>Uploader authentication</h2>
				</a>
				<p>You&#39;ll need to be authenticated to deploy files and upload the serving manifests.</p>
				<a href="#local-testing--user-account-authentication" id="local-testing--user-account-authentication" style="color: inherit; text-decoration: none;">
					<h3>Local testing / user account authentication</h3>
				</a>
				<p>If you are testing locally, your user account can be used to authenticate to
					Cloud Datastore and Cloud Storage. Simply run the below command to create
				credentials used for authentication:</p>
				<pre><code class="language-bash">gcloud auth application-default login</code></pre>
				<a href="#continuous-deployment--service-account-authentication" id="continuous-deployment--service-account-authentication" style="color: inherit; text-decoration: none;">
					<h3>Continuous deployment / service account authentication</h3>
				</a>
				<p>If you are using a service account for deployment, you&#39;ll need to ensure it has
				the right permissions.</p>
				<a href="#1-identify-the-service-account-to-use" id="1-identify-the-service-account-to-use" style="color: inherit; text-decoration: none;">
					<h4>1. Identify the service account to use.</h4>
				</a>
				<p>Authentication to upload your files is done using a service account. You&#39;ll
				generally want to use one of two service accounts:</p>
				<p><strong>Cloud Build service account</strong>: When the command is invoked from Google Cloud
					Build, your project&#39;s Cloud Build service account
				(<code>&lt;ProjectNumber&gt;@cloudbuild.gserviceaccount.com</code>) is used.</p>
				<p>To determine your project&#39;s project number:</p>
				<pre><code class="language-bash">gcloud projects describe &lt;AppId&gt;</code></pre>
				<p><strong>Application default service account</strong>: When the command is invoked locally
					(i.e. for testing or for manual uploads), you&#39;ll likely want to use your App
					Engine app&#39;s default service account (<code>&lt;AppId&gt;@appspot.gserviceaccount.com</code>).
				You can download a service account key by running:</p>
				<pre><code class="language-bash">gcloud iam service-accounts keys create \
  key.json \
  --iam-account &lt;AppId&gt;@appspot.gserviceaccount.com</code></pre>
				<p>NOTE: This will download a <code>key.json</code> to your current directory. Avoid
					committing this to your Git repository. You&#39;ll want to add <code>key.json</code> to
				<code>.gitignore</code>.</p>
				<a href="#2-ensure-service-account-has-permissions" id="2-ensure-service-account-has-permissions" style="color: inherit; text-decoration: none;">
					<h4>2. Ensure service account has permissions.</h4>
				</a>
				<p>The following permissions are needed:</p>
				<ul>
					<li>Cloud Datastore (manifests are stored here): Cloud Datastore Owner
					(<code>datastore.owner</code>)</li>
					<li>Cloud Storage (files are uploaded here): Storage Object Admin
					(<code>storage.objectAdmin</code>)</li>
				</ul>
				<p>If using the App Engine default service account, you will not need to modify the
					permissions, as the service account has the &quot;Project Editor&quot; permission by
				default.</p>
				<p>If using the Cloud Build service account (or any other service account), you&#39;ll
					need to add the above two permissions to the account. That can be done via the
					IAM page (<code>https://console.cloud.google.com/access/iam?project=&lt;AppId&gt;</code>) or via
				the <code>gcloud</code> CLI:</p>
				<pre><code>for role in datastore.owner storage.objectAdmin g; do \
  gcloud projects<span class="hljs-built_in"> add-iam-policy-binding </span>\
      &lt;AppId&gt;
      --member=serviceAccount:&lt;ProjectNumber&gt;@cloudbuild.gserviceaccount.com \
      --role=roles/$role \
; done</code></pre>
				<a href="#environments" id="environments" style="color: inherit; text-decoration: none;">
					<h2>Environments</h2>
				</a>
				<p>Fileset uses Git branches to determine whether files should be in production
					(and public) or in staging (and restricted via the Identity-Aware Proxy). The
					Git branch is determined by inspecting the local Git environment when the
				<code>upload</code> command is invoked.</p>
				<p>The best way to understand how this works is by following the examples below:</p>
				<pre><code class="language-bash"><span class="hljs-comment"># main branch</span>
<span class="hljs-comment"># ✓ public</span>
<span class="hljs-comment"># ✓ production URL</span>
<span class="hljs-comment"># ✓ also available from staging URL (restricted)</span>

(main) $ fileset upload build
...
 Public URL: https://appid.appspot.com
Staging URL: https://default-f3a9abb-dot-fileset-dot-appid.appspot.com</code></pre>
				<pre><code class="language-bash"><span class="hljs-comment"># staging branch</span>
<span class="hljs-comment"># ✓ not public; restricted by Identity-Aware Proxy</span>
<span class="hljs-comment"># ✓ staging URL only (restricted)</span>

(staging) $ fileset upload build
...
Staging URL: https://default-4fb48ce-dot-fileset-dot-appid.appspot.com</code></pre>
				<a href="#testing" id="testing" style="color: inherit; text-decoration: none;">
					<h2>Testing</h2>
				</a>
				<p>You can verify Fileset server is working as you expect by looking for the following headers:</p>
				<table>
					<thead>
						<tr>
							<th>Header</th>
							<th>Description</th>
						</tr>
					</thead>
					<tbody><tr>
							<td><code>x-fileset-site</code></td>
							<td>The site being served. Usually this will be <code>default</code> but for multi-site installations, this will be useful for determining which site is serving.</td>
						</tr>
						<tr>
							<td><code>x-fileset-ref</code></td>
							<td>The Git commit sha that corresponds to the serving manifest that is handling your request.</td>
						</tr>
						<tr>
							<td><code>x-fileset-blob</code></td>
							<td>The blob directory key corresponding to the file being served. This is the SHA-1 hash of the file&#39;s content.</td>
						</tr>
						<tr>
							<td><code>x-fileset-ttl</code></td>
							<td>For scheduled deployments, the value of this header will correspond to the timestamp for the timed deployment being served.</td>
						</tr>
				</tbody></table>
				<a href="#tips" id="tips" style="color: inherit; text-decoration: none;">
					<h2>Tips</h2>
				</a>
				<a href="#usage-within-makefile" id="usage-within-makefile" style="color: inherit; text-decoration: none;">
					<h3>Usage within Makefile</h3>
				</a>
				<p>The absolute path to the <code>fileset</code> executable must be specified to invoke the CLI.</p>
				<pre><code>.<span class="hljs-regexp">/node_modules/</span>.bin/fileset upload build</code></pre>
				<a href="#usage-with-growdev" id="usage-with-growdev" style="color: inherit; text-decoration: none;">
					<h3>Usage with Grow.dev</h3>
				</a>
				<p>First, build the site to the <code>build</code> directory. Then, upload the directory to Fileset.</p>
				<pre><code>grow <span class="hljs-keyword">build</span> --deployment=prod
fileset upload <span class="hljs-keyword">build</span></code></pre>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_commands_serve_.html">&quot;commands/serve&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_commands_upload_.html">&quot;commands/upload&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_gitdata_.html">&quot;gitdata&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_index_.html">&quot;index&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_manifest_.html">&quot;manifest&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_redirects_.html">&quot;redirects&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_server_.html">&quot;server&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_upload_.html">&quot;upload&quot;</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
</body>
</html>